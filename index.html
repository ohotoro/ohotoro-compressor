<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHOTORO HORIE Optimizer</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            background: #f6f6f6;
            color: #111;
            line-height: 1.6;
            font-size: 13px;
            letter-spacing: 0.02em;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 40px;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        h1 {
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 0.3em;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 10px;
            color: #666;
            letter-spacing: 0.15em;
        }

        .language-switch {
            position: absolute;
            top: 20px;
            left: 40px;
            display: flex;
            gap: 8px;
        }

        .lang-btn {
            padding: 6px 12px;
            background: none;
            border: 1px solid #e6e6e6;
            font-size: 10px;
            letter-spacing: 0.1em;
            cursor: pointer;
            color: #999;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            border-color: #999;
            color: #111;
        }

        .lang-btn.active {
            background: #111;
            color: #fff;
            border-color: #111;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 50px;
            border-bottom: 1px solid #e6e6e6;
        }

        .tab {
            padding: 12px 40px;
            background: none;
            border: none;
            font-size: 11px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
            position: relative;
        }

        .tab:hover {
            color: #111;
        }

        .tab.active {
            color: #111;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: #111;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 1px dashed #e6e6e6;
            padding: 80px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fff;
            margin-bottom: 40px;
        }

        .upload-area:hover {
            border-color: #999;
            background: #fafafa;
        }

        .upload-area.dragover {
            border-color: #111;
            background: #f5f5f5;
        }

        .upload-icon {
            font-size: 24px;
            margin-bottom: 16px;
            color: #ccc;
        }

        .upload-text {
            font-size: 11px;
            letter-spacing: 0.1em;
            color: #666;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 10px;
            color: #999;
        }

        input[type="file"] {
            display: none;
        }

        /* 크롭 영역 */
        .crop-section {
            display: none;
            background: #fff;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid #e6e6e6;
        }

        .crop-section.active {
            display: block;
        }

        .crop-container-wrapper {
            text-align: center;
            margin-bottom: 40px;
        }

        .crop-wrapper {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
            background: #000;
            display: inline-block;
            text-align: left;
        }

        .crop-canvas {
            display: block;
            max-width: 100%;
            max-height: 600px;
        }

        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .crop-box {
            position: absolute;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.3);
            cursor: move;
            pointer-events: auto;
        }

        .crop-overlay-top,
        .crop-overlay-bottom,
        .crop-overlay-left,
        .crop-overlay-right {
            position: absolute;
            background: rgba(0, 0, 0, 0.6);
            pointer-events: none;
        }

        .crop-overlay-top {
            top: 0;
            left: 0;
            right: 0;
        }

        .crop-overlay-bottom {
            bottom: 0;
            left: 0;
            right: 0;
        }

        .crop-overlay-left {
            left: 0;
        }

        .crop-overlay-right {
            right: 0;
        }

        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fff;
            border: 2px solid #111;
            pointer-events: auto;
        }

        .crop-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .crop-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .crop-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        .crop-handle.n { top: -5px; left: 50%; margin-left: -5px; cursor: n-resize; }
        .crop-handle.s { bottom: -5px; left: 50%; margin-left: -5px; cursor: s-resize; }
        .crop-handle.w { top: 50%; left: -5px; margin-top: -5px; cursor: w-resize; }
        .crop-handle.e { top: 50%; right: -5px; margin-top: -5px; cursor: e-resize; }

        .crop-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 6px 12px;
            font-size: 10px;
            letter-spacing: 0.1em;
            pointer-events: none;
            border-radius: 2px;
        }

        .settings-panel {
            background: #fff;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid #e6e6e6;
        }

        .settings-group {
            margin-bottom: 30px;
        }

        .settings-group:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #666;
            margin-bottom: 12px;
            display: block;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-option {
            position: relative;
            cursor: pointer;
            padding: 8px 16px;
            border: 1px solid #e6e6e6;
            font-size: 11px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .radio-option:hover {
            border-color: #999;
        }

        .radio-option input {
            position: absolute;
            opacity: 0;
        }

        .radio-option.selected {
            background: #111;
            color: #fff;
            border-color: #111;
        }

        .custom-input {
            display: none;
            margin-top: 12px;
            gap: 8px;
            align-items: center;
        }

        .custom-input.active {
            display: flex;
        }

        .custom-input input {
            padding: 8px 12px;
            border: 1px solid #e6e6e6;
            font-size: 11px;
            width: 100px;
            background: #fff;
        }

        .custom-input input:focus {
            outline: none;
            border-color: #111;
        }

        .button-group {
            display: none;
            justify-content: center;
            gap: 16px;
            margin-top: 0;
            padding-top: 20px;
            border-top: 1px solid #e6e6e6;
        }

        .btn {
            padding: 12px 32px;
            border: 1px solid #111;
            background: #111;
            color: #fff;
            font-size: 11px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-secondary {
            background: #fff;
            color: #111;
        }

        .file-list {
            display: none;
            margin-top: 30px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #fff;
            border: 1px solid #e6e6e6;
            margin-bottom: 8px;
            gap: 16px;
        }

        .file-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #e6e6e6;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 11px;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 10px;
            color: #999;
        }

        .file-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-status {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 4px 8px;
            background: #f5f5f5;
            white-space: nowrap;
        }

        .file-status.processing {
            background: #fff3cd;
        }

        .file-status.complete {
            background: #d4edda;
        }

        .file-status.error {
            background: #f8d7da;
        }

        .btn-recrop {
            padding: 6px 12px;
            border: 1px solid #e6e6e6;
            background: #fff;
            color: #666;
            font-size: 10px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-recrop:hover {
            border-color: #111;
            color: #111;
        }

        .stats {
            display: none;
            background: #fff;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid #e6e6e6;
        }

        .stat-item {
            flex: 1;
        }

        .stat-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 500;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-content {
            text-align: center;
            color: #fff;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 10px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #666;
        }

        .progress-bar {
            display: none;
            width: 100%;
            height: 2px;
            background: #e6e6e6;
            margin-top: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #111;
            transition: width 0.3s ease;
            width: 0;
        }

        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 20px 40px;
            font-size: 11px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 40px 20px;
            }

            .language-switch {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
            }

            .radio-group {
                flex-direction: column;
            }

            .stats {
                flex-direction: column;
                gap: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="language-switch">
                <button class="lang-btn active" data-lang="ja">日本語</button>
                <button class="lang-btn" data-lang="ko">한국어</button>
            </div>
            
            <div style="position: absolute; top: 20px; right: 40px;">
                <a href="https://admin.cre.ma/v2/review/products" target="_blank" 
                   style="padding: 8px 20px; background: none; border: 1px solid #e6e6e6; color: #666; text-decoration: none; font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; transition: all 0.3s ease;"
                   onmouseover="this.style.borderColor='#111'; this.style.color='#111';" 
                   onmouseout="this.style.borderColor='#e6e6e6'; this.style.color='#666';">
                    CREMA
                </a>
            </div>
            
            <h1>OHOTORO COMPRESSOR 🍣</h1>
            <div class="subtitle i18n" data-i18n="subtitle"></div>
            <div style="margin-top: 12px; font-size: 10px; color: #999; letter-spacing: 0.1em;">
                <span id="team-message" style="transition: opacity 0.3s ease;"></span>
            </div>
            <button id="reset-settings" class="i18n" style="margin-top: 20px; padding: 6px 16px; background: none; border: 1px solid #e6e6e6; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; color: #999; transition: all 0.3s ease;" 
                data-i18n="reset_settings"
                onmouseover="this.style.borderColor='#111'; this.style.color='#111';" 
                onmouseout="this.style.borderColor='#e6e6e6'; this.style.color='#999';"></button>
        </header>

        <div class="tabs">
            <button class="tab active i18n" data-tab="photo" data-i18n="tab_photo"></button>
            <button class="tab i18n" data-tab="video" data-i18n="tab_video"></button>
        </div>

        <!-- PHOTO TAB -->
        <div id="photo-tab" class="tab-content active">
            <div class="upload-area" id="photo-upload-area">
                <input type="file" id="photo-input" multiple accept="image/*">
                <div class="upload-icon">―</div>
                <div class="upload-text i18n" data-i18n="photo_upload_text"></div>
                <div class="upload-subtext i18n" data-i18n="photo_upload_subtext"></div>
                <div style="margin-top: 12px; font-size: 10px; color: #ccc;" class="i18n" data-i18n="multiple_files"></div>
            </div>

            <!-- 크롭 섹션 -->
            <div class="crop-section" id="crop-section">
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="settings-label i18n" data-i18n="crop_title"></div>
                        <div id="crop-progress-text" style="font-size: 11px; color: #666; letter-spacing: 0.1em;"></div>
                    </div>
                    
                    <div class="settings-group" style="margin-bottom: 30px;">
                        <label class="settings-label i18n" data-i18n="crop_ratio"></label>
                        <div class="radio-group">
                            <label class="radio-option selected">
                                <input type="radio" name="crop-ratio" value="5:7" checked>
                                <span>5:7</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="crop-ratio" value="1:1">
                                <span>1:1</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="crop-ratio" value="4:5">
                                <span>4:5</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="crop-ratio" value="16:9">
                                <span>16:9</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="crop-ratio" value="free">
                                <span class="i18n" data-i18n="ratio_free"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="crop-container-wrapper">
                    <div class="crop-wrapper" id="crop-wrapper">
                        <canvas id="crop-canvas" class="crop-canvas"></canvas>
                        <div class="crop-overlay">
                            <div class="crop-overlay-top" id="crop-overlay-top"></div>
                            <div class="crop-overlay-bottom" id="crop-overlay-bottom"></div>
                            <div class="crop-overlay-left" id="crop-overlay-left"></div>
                            <div class="crop-overlay-right" id="crop-overlay-right"></div>
                            <div class="crop-box" id="crop-box">
                                <div class="crop-handle nw"></div>
                                <div class="crop-handle ne"></div>
                                <div class="crop-handle sw"></div>
                                <div class="crop-handle se"></div>
                                <div class="crop-handle n"></div>
                                <div class="crop-handle s"></div>
                                <div class="crop-handle w"></div>
                                <div class="crop-handle e"></div>
                            </div>
                            <div class="crop-info" id="crop-info">0 × 0</div>
                        </div>
                    </div>
                </div>

                <div class="button-group" style="display: flex;">
                    <button class="btn btn-secondary" id="prev-crop" style="display: none;" data-i18n="prev_image"></button>
                    <button class="btn btn-secondary" id="skip-crop" data-i18n="skip_crop"></button>
                    <button class="btn" id="apply-crop" data-i18n="apply_crop"></button>
                </div>
            </div>

            <div class="settings-panel" id="photo-settings" style="display: none;">
                <div class="settings-group">
                    <label class="settings-label i18n" data-i18n="quality"></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="photo-quality" value="90">
                            <span class="i18n" data-i18n="quality_high"></span>
                        </label>
                        <label class="radio-option selected">
                            <input type="radio" name="photo-quality" value="70" checked>
                            <span class="i18n" data-i18n="quality_medium"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="photo-quality" value="50">
                            <span class="i18n" data-i18n="quality_low"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="photo-quality" value="30">
                            <span class="i18n" data-i18n="quality_web"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-group">
                    <label class="settings-label i18n" data-i18n="size"></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="photo-size" value="original">
                            <span class="i18n" data-i18n="size_original"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="photo-size" value="2000">
                            2000px
                        </label>
                        <label class="radio-option selected">
                            <input type="radio" name="photo-size" value="1500" checked>
                            1500px
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="photo-size" value="1000">
                            1000px
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="photo-size" value="custom">
                            <span class="i18n" data-i18n="size_custom"></span>
                        </label>
                    </div>
                    <div class="custom-input" id="photo-custom-size">
                        <input type="number" id="photo-custom-value" placeholder="800" min="100" max="5000">
                        <span>px</span>
                    </div>
                </div>

                <div class="settings-group">
                    <label class="settings-label i18n" data-i18n="format"></label>
                    <div class="radio-group">
                        <label class="radio-option selected">
                            <input type="radio" name="photo-format" value="jpeg" checked>
                            JPEG
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="photo-format" value="png">
                            PNG
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="photo-format" value="webp">
                            WebP
                        </label>
                    </div>
                </div>
            </div>

            <div class="file-list" id="photo-file-list"></div>

            <div class="progress-bar" id="photo-progress">
                <div class="progress-fill"></div>
            </div>

            <div class="stats" id="photo-stats">
                <div class="stat-item">
                    <div class="stat-value" id="photo-total-files">0</div>
                    <div class="stat-label i18n" data-i18n="stat_files"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="photo-original-size">0 MB</div>
                    <div class="stat-label i18n" data-i18n="stat_original_size"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="photo-compressed-size">0 MB</div>
                    <div class="stat-label i18n" data-i18n="stat_compressed_size"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="photo-saved" style="color: #666; font-weight: 400;">0%</div>
                    <div class="stat-label i18n" data-i18n="stat_saved"></div>
                </div>
            </div>

            <div class="button-group" id="photo-buttons">
                <button class="btn btn-secondary i18n" id="photo-clear" data-i18n="btn_clear"></button>
                <button class="btn i18n" id="photo-process" data-i18n="btn_process"></button>
                <button class="btn i18n" id="photo-download" style="display: none;" data-i18n="btn_download"></button>
            </div>
        </div>

        <!-- VIDEO TAB -->
        <div id="video-tab" class="tab-content">
            <div class="upload-area" id="video-upload-area">
                <input type="file" id="video-input" multiple accept="video/*">
                <div class="upload-icon">―</div>
                <div class="upload-text i18n" data-i18n="video_upload_text"></div>
                <div class="upload-subtext i18n" data-i18n="video_upload_subtext"></div>
                <div style="margin-top: 12px; font-size: 10px; color: #ccc;" class="i18n" data-i18n="multiple_files"></div>
            </div>

            <div class="settings-panel" id="video-settings" style="display: none;">
                <div class="settings-group">
                    <label class="settings-label i18n" data-i18n="quality"></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="video-quality" value="high">
                            <span class="i18n" data-i18n="quality_high_simple"></span>
                        </label>
                        <label class="radio-option selected">
                            <input type="radio" name="video-quality" value="medium" checked>
                            <span class="i18n" data-i18n="quality_medium_simple"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="video-quality" value="low">
                            <span class="i18n" data-i18n="quality_low_simple"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-group">
                    <label class="settings-label i18n" data-i18n="resolution"></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="video-resolution" value="original">
                            <span class="i18n" data-i18n="size_original"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="video-resolution" value="1080">
                            1080p
                        </label>
                        <label class="radio-option selected">
                            <input type="radio" name="video-resolution" value="720" checked>
                            720p
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="video-resolution" value="480">
                            480p
                        </label>
                    </div>
                </div>

                <div class="settings-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="remove-audio" style="width: 16px; height: 16px; cursor: pointer;">
                        <span class="i18n" data-i18n="remove_audio"></span>
                    </label>
                </div>
            </div>

            <div class="file-list" id="video-file-list"></div>

            <div class="progress-bar" id="video-progress">
                <div class="progress-fill"></div>
            </div>

            <div class="stats" id="video-stats">
                <div class="stat-item">
                    <div class="stat-value" id="video-total-files">0</div>
                    <div class="stat-label i18n" data-i18n="stat_files"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="video-original-size">0 MB</div>
                    <div class="stat-label i18n" data-i18n="stat_original_size"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="video-compressed-size">0 MB</div>
                    <div class="stat-label i18n" data-i18n="stat_compressed_size"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="video-saved" style="color: #666; font-weight: 400;">0%</div>
                    <div class="stat-label i18n" data-i18n="stat_saved"></div>
                </div>
            </div>

            <div class="button-group" id="video-buttons">
                <button class="btn btn-secondary i18n" id="video-clear" data-i18n="btn_clear"></button>
                <button class="btn i18n" id="video-process" data-i18n="btn_process"></button>
                <button class="btn i18n" id="video-download" style="display: none;" data-i18n="btn_download"></button>
            </div>
        </div>
    </div>

    <div class="loading" id="photo-loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text i18n" data-i18n="loading"></div>
        </div>
    </div>

    <div class="loading" id="video-loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text i18n" data-i18n="loading"></div>
        </div>
    </div>

    <script>
        const translations = {
            ja: {
                subtitle: "Photo / Video Optimizer",
                reset_settings: "設定を初期化",
                tab_photo: "画像",
                tab_video: "動画",
                photo_upload_text: "画像をここにドラッグ",
                photo_upload_subtext: "クリックで選択",
                video_upload_text: "動画をここにドラッグ",
                video_upload_subtext: "クリックで選択（最大100MB）",
                multiple_files: "複数可",
                crop_title: "画像をクロップ",
                crop_ratio: "アスペクト比",
                ratio_free: "自由",
                apply_crop: "クロップを適用",
                skip_crop: "スキップ",
                prev_image: "前へ",
                recrop: "再クロップ",
                quality: "品質",
                quality_high: "高 (90%)",
                quality_medium: "中 (70%)",
                quality_low: "低 (50%)",
                quality_web: "Web (30%)",
                quality_high_simple: "高",
                quality_medium_simple: "中",
                quality_low_simple: "低",
                size: "サイズ",
                size_original: "オリジナル",
                size_custom: "カスタム",
                format: "形式",
                resolution: "解像度",
                remove_audio: "音声を削除",
                stat_files: "ファイル数",
                stat_original_size: "元のサイズ",
                stat_compressed_size: "圧縮後",
                stat_saved: "削減率",
                btn_clear: "全てクリア",
                btn_process: "実行",
                btn_download: "一括ダウンロード",
                loading: "処理中...",
                status_waiting: "待機",
                status_processing: "処理中",
                status_complete: "完了",
                status_error: "エラー",
                message_compressed: "件の画像を圧縮しました。",
                message_compressed_video: "件の動画を圧縮しました。",
                message_preparing: "準備中...",
                message_complete: "完了",
                message_reset_confirm: "設定を初期化しますか？",
                message_initialized: "初期化しました",
                message_ready: "準備中です。もう一度お試しください",
                team_messages: [
                    "静かに整える。確かに進める。",
                    "軽くして、速くする。",
                    "細部に、意図を。",
                    "必要なだけ、十分に。",
                    "静度と速度のバランス。",
                    "見えない部分まで、丁寧に。"
                ]
            },
            ko: {
                subtitle: "사진 / 동영상 최적화",
                reset_settings: "설정 초기화",
                tab_photo: "이미지",
                tab_video: "동영상",
                photo_upload_text: "이미지를 여기에 드래그",
                photo_upload_subtext: "클릭하여 선택",
                video_upload_text: "동영상을 여기에 드래그",
                video_upload_subtext: "클릭하여 선택 (최대 100MB)",
                multiple_files: "복수 선택 가능",
                crop_title: "이미지 크롭",
                crop_ratio: "비율",
                ratio_free: "자유",
                apply_crop: "크롭 적용",
                skip_crop: "건너뛰기",
                prev_image: "이전",
                recrop: "다시 크롭",
                quality: "품질",
                quality_high: "높음 (90%)",
                quality_medium: "중간 (70%)",
                quality_low: "낮음 (50%)",
                quality_web: "웹 (30%)",
                quality_high_simple: "높음",
                quality_medium_simple: "중간",
                quality_low_simple: "낮음",
                size: "크기",
                size_original: "원본",
                size_custom: "사용자 지정",
                format: "형식",
                resolution: "해상도",
                remove_audio: "오디오 제거",
                stat_files: "파일 수",
                stat_original_size: "원본 크기",
                stat_compressed_size: "압축 후",
                stat_saved: "절감률",
                btn_clear: "모두 지우기",
                btn_process: "실행",
                btn_download: "일괄 다운로드",
                loading: "처리 중...",
                status_waiting: "대기",
                status_processing: "처리 중",
                status_complete: "완료",
                status_error: "오류",
                message_compressed: "개의 이미지를 압축했습니다.",
                message_compressed_video: "개의 동영상을 압축했습니다.",
                message_preparing: "준비 중...",
                message_complete: "완료",
                message_reset_confirm: "설정을 초기화하시겠습니까?",
                message_initialized: "초기화되었습니다",
                message_ready: "준비 중입니다. 다시 시도해주세요",
                team_messages: [
                    "우리 스타일로, 조용히 잘 하고 있죠 🙂",
                    "빠르게보단 단단하게.",
                    "디테일은 태도에서 온다.",
                    "대충 안 해요, 자연스럽게 할 뿐.",
                    "정적과 속도의 균형.",
                    "보이지 않아도, 느껴지는 완성도."
                ]
            }
        };

        let currentLang = 'ja';
        let teamMessages = [];
        let messageIndex = 0;

        let photoFiles = [];
        let videoFiles = [];
        let croppedPhotos = [];
        let processedPhotos = [];
        let processedVideos = [];
        let currentImage = null;
        let currentImageIndex = 0;
        let ffmpeg = null;
        let ffmpegLoaded = false;

        // 크롭 변수
        let cropBox = null;
        let isDragging = false;
        let isResizing = false;
        let resizeHandle = null;
        let startX, startY;
        let cropData = { x: 0, y: 0, width: 0, height: 0 };

        function initLanguage() {
            const savedLang = localStorage.getItem('ohotoro-language');
            if (savedLang) {
                currentLang = savedLang;
            } else {
                const browserLang = navigator.language || navigator.userLanguage;
                currentLang = browserLang.startsWith('ko') ? 'ko' : 'ja';
            }
            updateLanguage(currentLang);
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
        }

        function updateLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('ohotoro-language', lang);
            const trans = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (trans[key]) el.textContent = trans[key];
            });
            const teamMsg = document.getElementById('team-message');
            if (teamMsg && trans.team_messages) {
                teamMsg.textContent = trans.team_messages[0];
            }
            teamMessages = trans.team_messages || [];
        }

        function getMessage(key) {
            return translations[currentLang][key] || key;
        }

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                updateLanguage(this.dataset.lang);
            });
        });

        // 팀 메시지 로테이션
        setInterval(() => {
            if (teamMessages.length === 0) return;
            messageIndex = (messageIndex + 1) % teamMessages.length;
            const msgEl = document.getElementById('team-message');
            if (msgEl) {
                msgEl.style.opacity = '0';
                setTimeout(() => {
                    msgEl.textContent = teamMessages[messageIndex];
                    msgEl.style.opacity = '1';
                }, 300);
            }
        }, 30000);

        // 설정 저장/불러오기
        const settings = {
            defaults: {
                photo: { quality: '70', size: '1500', format: 'jpeg' },
                video: { quality: 'medium', resolution: '720', removeAudio: false }
            },
            load: function() {
                const saved = localStorage.getItem('ohotoro-settings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // defaults와 merge하여 누락된 값 채우기
                    return {
                        photo: { ...this.defaults.photo, ...(parsed.photo || {}) },
                        video: { ...this.defaults.video, ...(parsed.video || {}) }
                    };
                }
                return this.defaults;
            },
            save: function(type, key, value) {
                const current = this.load();
                if (!current[type]) current[type] = {};
                current[type][key] = value;
                localStorage.setItem('ohotoro-settings', JSON.stringify(current));
            },
            apply: function() {
                const saved = this.load();
                
                // Photo 설정 적용
                ['quality', 'size', 'format'].forEach(key => {
                    if (!saved.photo || !saved.photo[key]) return;
                    const input = document.querySelector(`input[name="photo-${key}"][value="${saved.photo[key]}"]`);
                    if (input) {
                        input.checked = true;
                        input.closest('.radio-option').classList.add('selected');
                        document.querySelectorAll(`input[name="photo-${key}"]`).forEach(i => {
                            if (i !== input) i.closest('.radio-option').classList.remove('selected');
                        });
                    }
                });
                
                // Video 설정 적용
                ['quality', 'resolution'].forEach(key => {
                    if (!saved.video || !saved.video[key]) return;
                    const input = document.querySelector(`input[name="video-${key}"][value="${saved.video[key]}"]`);
                    if (input) {
                        input.checked = true;
                        input.closest('.radio-option').classList.add('selected');
                        document.querySelectorAll(`input[name="video-${key}"]`).forEach(i => {
                            if (i !== input) i.closest('.radio-option').classList.remove('selected');
                        });
                    }
                });
                
                const removeAudioCheckbox = document.getElementById('remove-audio');
                if (removeAudioCheckbox && saved.video) {
                    removeAudioCheckbox.checked = saved.video.removeAudio || false;
                }
            }
        };

        // 탭 전환
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });

        // 라디오 버튼
        document.querySelectorAll('.radio-option').forEach(option => {
            option.addEventListener('click', function() {
                const input = this.querySelector('input');
                const groupName = input.name;
                document.querySelectorAll(`input[name="${groupName}"]`).forEach(i => {
                    i.closest('.radio-option').classList.remove('selected');
                });
                this.classList.add('selected');
                input.checked = true;

                // 설정 저장
                const value = input.value;
                if (groupName.startsWith('photo-')) {
                    const key = groupName.replace('photo-', '');
                    settings.save('photo', key, value);
                    if (key === 'size') {
                        const customInput = document.getElementById('photo-custom-size');
                        customInput.classList.toggle('active', value === 'custom');
                    }
                } else if (groupName.startsWith('video-')) {
                    const key = groupName.replace('video-', '');
                    settings.save('video', key, value);
                }

                // 크롭 비율 변경
                if (groupName === 'crop-ratio' && currentImage) {
                    updateCropRatio(value);
                }
            });
        });

        function showSuccessMessage(message) {
            const div = document.createElement('div');
            div.className = 'success-message';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

        // ============= PHOTO =============
        const photoInput = document.getElementById('photo-input');
        const photoUploadArea = document.getElementById('photo-upload-area');
        const cropCanvas = document.getElementById('crop-canvas');
        const ctx = cropCanvas.getContext('2d');

        photoUploadArea.addEventListener('click', () => photoInput.click());
        photoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            photoUploadArea.classList.add('dragover');
        });
        photoUploadArea.addEventListener('dragleave', () => {
            photoUploadArea.classList.remove('dragover');
        });
        photoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            photoUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            handlePhotoFiles(files);
        });
        photoInput.addEventListener('change', (e) => {
            handlePhotoFiles(Array.from(e.target.files));
        });

        function handlePhotoFiles(files) {
            if (files.length === 0) return;
            photoFiles = files;
            currentImageIndex = 0;
            croppedPhotos = new Array(files.length).fill(null);
            loadImageForCrop(0);
        }

        function loadImageForCrop(index) {
            if (index >= photoFiles.length) {
                // 크롭되지 않은 이미지가 있는지 확인
                const uncroppedIndex = croppedPhotos.findIndex((item, i) => !item);
                if (uncroppedIndex !== -1) {
                    loadImageForCrop(uncroppedIndex);
                    return;
                }
                finishCropping();
                return;
            }
            
            if (index < 0) {
                index = 0;
            }

            currentImageIndex = index;
            const file = photoFiles[index];
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    setupCropArea(img);
                    
                    // 이미 크롭한 적이 있으면 그 정보 불러오기
                    if (croppedPhotos[index] && croppedPhotos[index].crop) {
                        const saved = croppedPhotos[index].crop;
                        const scaleX = cropCanvas.width / img.width;
                        const scaleY = cropCanvas.height / img.height;
                        
                        cropData = {
                            x: saved.x * scaleX,
                            y: saved.y * scaleY,
                            width: saved.width * scaleX,
                            height: saved.height * scaleY
                        };
                        updateCropBox();
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function setupCropArea(img) {
            document.getElementById('crop-section').classList.add('active');
            
            // 진행 상태 표시
            const progressText = document.getElementById('crop-progress-text');
            const fileName = photoFiles[currentImageIndex].name;
            progressText.textContent = `${currentImageIndex + 1}/${photoFiles.length} - ${fileName}`;
            
            // 이전 버튼 표시/숨김
            const prevBtn = document.getElementById('prev-crop');
            prevBtn.style.display = currentImageIndex > 0 ? 'inline-block' : 'none';
            
            const maxWidth = 800;
            const maxHeight = 600;
            let width = img.width;
            let height = img.height;
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }
            cropCanvas.width = width;
            cropCanvas.height = height;
            
            // wrapper 크기를 캔버스와 동일하게 설정
            const wrapper = document.getElementById('crop-wrapper');
            wrapper.style.width = width + 'px';
            wrapper.style.height = height + 'px';
            
            ctx.clearRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            initCropBox();
        }

        function initCropBox() {
            cropBox = document.getElementById('crop-box');
            const ratio = document.querySelector('input[name="crop-ratio"]:checked').value;
            const canvasWidth = cropCanvas.width;
            const canvasHeight = cropCanvas.height;
            let width, height;
            
            if (ratio === 'free') {
                // 가로 기준 100% 꽉차게
                width = canvasWidth;
                height = canvasHeight;
            } else {
                const [w, h] = ratio.split(':').map(Number);
                const aspectRatio = w / h;
                
                // 가로 기준 100% 꽉차게
                width = canvasWidth;
                height = width / aspectRatio;
                
                // 높이가 캔버스를 넘으면 높이 기준으로 재계산
                if (height > canvasHeight) {
                    height = canvasHeight;
                    width = height * aspectRatio;
                }
            }
            
            cropData = {
                x: (canvasWidth - width) / 2,
                y: (canvasHeight - height) / 2,
                width: width,
                height: height
            };
            updateCropBox();
            setupCropHandlers();
        }

        function updateCropBox() {
            cropBox.style.left = cropData.x + 'px';
            cropBox.style.top = cropData.y + 'px';
            cropBox.style.width = cropData.width + 'px';
            cropBox.style.height = cropData.height + 'px';
            
            // 4개 오버레이 업데이트
            const overlayTop = document.getElementById('crop-overlay-top');
            const overlayBottom = document.getElementById('crop-overlay-bottom');
            const overlayLeft = document.getElementById('crop-overlay-left');
            const overlayRight = document.getElementById('crop-overlay-right');
            
            overlayTop.style.height = cropData.y + 'px';
            overlayBottom.style.height = (cropCanvas.height - cropData.y - cropData.height) + 'px';
            
            overlayLeft.style.top = cropData.y + 'px';
            overlayLeft.style.width = cropData.x + 'px';
            overlayLeft.style.height = cropData.height + 'px';
            
            overlayRight.style.top = cropData.y + 'px';
            overlayRight.style.width = (cropCanvas.width - cropData.x - cropData.width) + 'px';
            overlayRight.style.height = cropData.height + 'px';
            
            const scaleX = currentImage.width / cropCanvas.width;
            const scaleY = currentImage.height / cropCanvas.height;
            const actualWidth = Math.round(cropData.width * scaleX);
            const actualHeight = Math.round(cropData.height * scaleY);
            document.getElementById('crop-info').textContent = `${actualWidth} × ${actualHeight}`;
        }

        function updateCropRatio(ratio) {
            if (ratio === 'free') {
                updateCropBox();
                return;
            }
            const [w, h] = ratio.split(':').map(Number);
            const aspectRatio = w / h;
            const centerX = cropData.x + cropData.width / 2;
            const centerY = cropData.y + cropData.height / 2;
            
            // 가로 기준 100% 유지
            let newWidth = cropCanvas.width;
            let newHeight = newWidth / aspectRatio;
            
            // 높이가 캔버스를 벗어나면 높이 기준으로 재계산
            if (newHeight > cropCanvas.height) {
                newHeight = cropCanvas.height;
                newWidth = newHeight * aspectRatio;
            }
            
            cropData.width = newWidth;
            cropData.height = newHeight;
            cropData.x = centerX - newWidth / 2;
            cropData.y = centerY - newHeight / 2;
            
            // 경계 체크
            cropData.x = Math.max(0, Math.min(cropData.x, cropCanvas.width - cropData.width));
            cropData.y = Math.max(0, Math.min(cropData.y, cropCanvas.height - cropData.height));
            
            updateCropBox();
        }

        function setupCropHandlers() {
            cropBox.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('crop-handle')) {
                    isResizing = true;
                    resizeHandle = e.target.className.split(' ')[1];
                } else {
                    isDragging = true;
                }
                startX = e.clientX;
                startY = e.clientY;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging && !isResizing) return;
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                if (isDragging) {
                    cropData.x += deltaX;
                    cropData.y += deltaY;
                    cropData.x = Math.max(0, Math.min(cropData.x, cropCanvas.width - cropData.width));
                    cropData.y = Math.max(0, Math.min(cropData.y, cropCanvas.height - cropData.height));
                } else if (isResizing) {
                    const ratio = document.querySelector('input[name="crop-ratio"]:checked').value;
                    handleResize(deltaX, deltaY, resizeHandle, ratio !== 'free');
                }
                startX = e.clientX;
                startY = e.clientY;
                updateCropBox();
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                isResizing = false;
                resizeHandle = null;
            });
        }

        function handleResize(deltaX, deltaY, handle, isFixedRatio) {
            const ratio = document.querySelector('input[name="crop-ratio"]:checked').value;
            let aspectRatio = 1;
            if (isFixedRatio) {
                const [w, h] = ratio.split(':').map(Number);
                aspectRatio = w / h;
            }
            const minSize = 50;
            
            switch (handle) {
                case 'se':
                    if (isFixedRatio) {
                        const newWidth = Math.max(minSize, Math.min(cropData.width + deltaX, cropCanvas.width - cropData.x));
                        cropData.width = newWidth;
                        cropData.height = cropData.width / aspectRatio;
                        if (cropData.y + cropData.height > cropCanvas.height) {
                            cropData.height = cropCanvas.height - cropData.y;
                            cropData.width = cropData.height * aspectRatio;
                        }
                    } else {
                        cropData.width = Math.max(minSize, Math.min(cropData.width + deltaX, cropCanvas.width - cropData.x));
                        cropData.height = Math.max(minSize, Math.min(cropData.height + deltaY, cropCanvas.height - cropData.y));
                    }
                    break;
                case 'sw':
                    if (isFixedRatio) {
                        const newWidth = cropData.width - deltaX;
                        if (newWidth >= minSize && cropData.x + deltaX >= 0) {
                            cropData.x += deltaX;
                            cropData.width = newWidth;
                            cropData.height = cropData.width / aspectRatio;
                            if (cropData.y + cropData.height > cropCanvas.height) {
                                cropData.height = cropCanvas.height - cropData.y;
                                cropData.width = cropData.height * aspectRatio;
                            }
                        }
                    } else {
                        if (cropData.width - deltaX >= minSize && cropData.x + deltaX >= 0) {
                            cropData.x += deltaX;
                            cropData.width -= deltaX;
                        }
                        cropData.height = Math.max(minSize, Math.min(cropData.height + deltaY, cropCanvas.height - cropData.y));
                    }
                    break;
                case 'ne':
                    if (isFixedRatio) {
                        const newWidth = cropData.width + deltaX;
                        if (newWidth >= minSize && newWidth <= cropCanvas.width - cropData.x) {
                            cropData.width = newWidth;
                            const newHeight = cropData.width / aspectRatio;
                            const newY = cropData.y + cropData.height - newHeight;
                            if (newY >= 0) {
                                cropData.height = newHeight;
                                cropData.y = newY;
                            }
                        }
                    } else {
                        cropData.width = Math.max(minSize, Math.min(cropData.width + deltaX, cropCanvas.width - cropData.x));
                        if (cropData.height - deltaY >= minSize && cropData.y + deltaY >= 0) {
                            cropData.y += deltaY;
                            cropData.height -= deltaY;
                        }
                    }
                    break;
                case 'nw':
                    if (isFixedRatio) {
                        const newWidth = cropData.width - deltaX;
                        if (newWidth >= minSize && cropData.x + deltaX >= 0) {
                            cropData.width = newWidth;
                            cropData.x += deltaX;
                            const newHeight = cropData.width / aspectRatio;
                            const newY = cropData.y + cropData.height - newHeight;
                            if (newY >= 0) {
                                cropData.height = newHeight;
                                cropData.y = newY;
                            }
                        }
                    } else {
                        if (cropData.width - deltaX >= minSize && cropData.x + deltaX >= 0) {
                            cropData.x += deltaX;
                            cropData.width -= deltaX;
                        }
                        if (cropData.height - deltaY >= minSize && cropData.y + deltaY >= 0) {
                            cropData.y += deltaY;
                            cropData.height -= deltaY;
                        }
                    }
                    break;
                case 'n':
                    if (!isFixedRatio && cropData.height - deltaY >= minSize && cropData.y + deltaY >= 0) {
                        cropData.y += deltaY;
                        cropData.height -= deltaY;
                    }
                    break;
                case 's':
                    if (!isFixedRatio) {
                        cropData.height = Math.max(minSize, Math.min(cropData.height + deltaY, cropCanvas.height - cropData.y));
                    }
                    break;
                case 'w':
                    if (!isFixedRatio && cropData.width - deltaX >= minSize && cropData.x + deltaX >= 0) {
                        cropData.x += deltaX;
                        cropData.width -= deltaX;
                    }
                    break;
                case 'e':
                    if (!isFixedRatio) {
                        cropData.width = Math.max(minSize, Math.min(cropData.width + deltaX, cropCanvas.width - cropData.x));
                    }
                    break;
            }
        }

        document.getElementById('apply-crop').addEventListener('click', () => {
            const scaleX = currentImage.width / cropCanvas.width;
            const scaleY = currentImage.height / cropCanvas.height;
            const cropInfo = {
                x: Math.round(cropData.x * scaleX),
                y: Math.round(cropData.y * scaleY),
                width: Math.round(cropData.width * scaleX),
                height: Math.round(cropData.height * scaleY)
            };
            
            // 썸네일 생성
            const thumbCanvas = document.createElement('canvas');
            const thumbCtx = thumbCanvas.getContext('2d');
            thumbCanvas.width = 60;
            thumbCanvas.height = 60;
            
            const thumbScale = Math.max(60 / cropInfo.width, 60 / cropInfo.height);
            const thumbWidth = cropInfo.width * thumbScale;
            const thumbHeight = cropInfo.height * thumbScale;
            const thumbX = (60 - thumbWidth) / 2;
            const thumbY = (60 - thumbHeight) / 2;
            
            thumbCtx.drawImage(
                currentImage,
                cropInfo.x, cropInfo.y, cropInfo.width, cropInfo.height,
                thumbX, thumbY, thumbWidth, thumbHeight
            );
            
            const thumbnail = thumbCanvas.toDataURL('image/jpeg', 0.7);
            
            croppedPhotos[currentImageIndex] = {
                image: currentImage,
                crop: cropInfo,
                file: photoFiles[currentImageIndex],
                thumbnail: thumbnail
            };
            
            loadImageForCrop(currentImageIndex + 1);
        });

        document.getElementById('skip-crop').addEventListener('click', () => {
            // 원본 이미지 썸네일 생성
            const thumbCanvas = document.createElement('canvas');
            const thumbCtx = thumbCanvas.getContext('2d');
            thumbCanvas.width = 60;
            thumbCanvas.height = 60;
            
            const thumbScale = Math.max(60 / currentImage.width, 60 / currentImage.height);
            const thumbWidth = currentImage.width * thumbScale;
            const thumbHeight = currentImage.height * thumbScale;
            const thumbX = (60 - thumbWidth) / 2;
            const thumbY = (60 - thumbHeight) / 2;
            
            thumbCtx.drawImage(currentImage, thumbX, thumbY, thumbWidth, thumbHeight);
            const thumbnail = thumbCanvas.toDataURL('image/jpeg', 0.7);
            
            croppedPhotos[currentImageIndex] = {
                image: currentImage,
                crop: null,
                file: photoFiles[currentImageIndex],
                thumbnail: thumbnail
            };
            
            loadImageForCrop(currentImageIndex + 1);
        });

        document.getElementById('prev-crop').addEventListener('click', () => {
            if (currentImageIndex > 0) {
                loadImageForCrop(currentImageIndex - 1);
            }
        });

        function finishCropping() {
            document.getElementById('crop-section').classList.remove('active');
            document.getElementById('photo-settings').style.display = 'block';
            document.getElementById('photo-file-list').style.display = 'block';
            document.getElementById('photo-buttons').style.display = 'flex';
            displayPhotoFiles();
        }

        function displayPhotoFiles() {
            const fileList = document.getElementById('photo-file-list');
            fileList.style.display = 'block';
            fileList.innerHTML = '';
            croppedPhotos.forEach((item, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const thumbnailHTML = item && item.thumbnail 
                    ? `<img src="${item.thumbnail}" class="file-thumbnail" alt="thumbnail">`
                    : '<div class="file-thumbnail" style="background: #f5f5f5;"></div>';
                
                fileItem.innerHTML = `
                    ${thumbnailHTML}
                    <div class="file-info">
                        <div class="file-name">${item.file.name}</div>
                        <div class="file-size">${formatFileSize(item.file.size)}</div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-recrop i18n" data-index="${index}" data-i18n="recrop">${getMessage('recrop')}</button>
                        <div class="file-status" id="photo-status-${index}">${getMessage('status_waiting')}</div>
                    </div>
                `;
                
                // 다시 크롭 버튼 이벤트
                const recropBtn = fileItem.querySelector('.btn-recrop');
                recropBtn.addEventListener('click', () => {
                    document.getElementById('photo-settings').style.display = 'none';
                    document.getElementById('photo-file-list').style.display = 'none';
                    document.getElementById('photo-buttons').style.display = 'none';
                    loadImageForCrop(index);
                });
                
                fileList.appendChild(fileItem);
            });
        }

        document.getElementById('photo-process').addEventListener('click', async () => {
            const quality = parseInt(document.querySelector('input[name="photo-quality"]:checked').value);
            const size = document.querySelector('input[name="photo-size"]:checked').value;
            const format = document.querySelector('input[name="photo-format"]:checked').value;
            
            const loading = document.getElementById('photo-loading');
            loading.style.display = 'flex';
            const progressBar = document.getElementById('photo-progress');
            progressBar.style.display = 'block';
            
            processedPhotos = [];
            let totalOriginalSize = 0;
            let totalCompressedSize = 0;

            for (let i = 0; i < croppedPhotos.length; i++) {
                const item = croppedPhotos[i];
                const statusEl = document.getElementById(`photo-status-${i}`);
                statusEl.textContent = getMessage('status_processing');
                statusEl.className = 'file-status processing';

                try {
                    const processed = await processPhoto(item, quality, size, format);
                    processedPhotos.push(processed);
                    totalOriginalSize += item.file.size;
                    totalCompressedSize += processed.blob.size;
                    statusEl.textContent = getMessage('status_complete');
                    statusEl.className = 'file-status complete';
                } catch (error) {
                    console.error('Error:', error);
                    statusEl.textContent = getMessage('status_error');
                    statusEl.className = 'file-status error';
                }

                progressBar.querySelector('.progress-fill').style.width = ((i + 1) / croppedPhotos.length) * 100 + '%';
            }

            loading.style.display = 'none';
            displayPhotoStats(totalOriginalSize, totalCompressedSize);
            showSuccessMessage(`${croppedPhotos.length}${getMessage('message_compressed')}`);
            document.getElementById('photo-download').style.display = 'inline-block';
            progressBar.style.display = 'none';
        });

        async function processPhoto(item, quality, size, format) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let sourceX = 0, sourceY = 0, sourceWidth = item.image.width, sourceHeight = item.image.height;
                if (item.crop) {
                    sourceX = item.crop.x;
                    sourceY = item.crop.y;
                    sourceWidth = item.crop.width;
                    sourceHeight = item.crop.height;
                }
                
                let targetWidth = sourceWidth;
                let targetHeight = sourceHeight;
                
                if (size === 'custom') {
                    const customValue = parseInt(document.getElementById('photo-custom-value').value) || sourceWidth;
                    const ratio = Math.min(customValue / sourceWidth, customValue / sourceHeight);
                    if (ratio < 1) {
                        targetWidth = Math.round(sourceWidth * ratio);
                        targetHeight = Math.round(sourceHeight * ratio);
                    }
                } else if (size !== 'original') {
                    const maxSize = parseInt(size);
                    const ratio = Math.min(maxSize / sourceWidth, maxSize / sourceHeight);
                    if (ratio < 1) {
                        targetWidth = Math.round(sourceWidth * ratio);
                        targetHeight = Math.round(sourceHeight * ratio);
                    }
                }
                
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                ctx.drawImage(item.image, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, targetWidth, targetHeight);
                
                let mimeType = 'image/jpeg';
                let ext = 'jpg';
                if (format === 'png') {
                    mimeType = 'image/png';
                    ext = 'png';
                } else if (format === 'webp') {
                    mimeType = 'image/webp';
                    ext = 'webp';
                }
                
                canvas.toBlob((blob) => {
                    const baseName = item.file.name.substring(0, item.file.name.lastIndexOf('.')) || item.file.name;
                    resolve({ blob: blob, name: `${baseName}.${ext}` });
                }, mimeType, quality / 100);
            });
        }

        function displayPhotoStats(originalSize, compressedSize) {
            const stats = document.getElementById('photo-stats');
            stats.style.display = 'flex';
            stats.style.justifyContent = 'space-around';
            stats.style.textAlign = 'center';
            document.getElementById('photo-total-files').textContent = croppedPhotos.length;
            document.getElementById('photo-original-size').textContent = formatFileSize(originalSize);
            document.getElementById('photo-compressed-size').textContent = formatFileSize(compressedSize);
            const savedPercentage = Math.round((1 - compressedSize / originalSize) * 100);
            document.getElementById('photo-saved').textContent = savedPercentage + '%';
        }

        document.getElementById('photo-download').addEventListener('click', async () => {
            if (processedPhotos.length === 0) return;
            showSuccessMessage(getMessage('message_preparing'));
            if (processedPhotos.length === 1) {
                downloadFile(processedPhotos[0].blob, processedPhotos[0].name);
            } else {
                const zip = new JSZip();
                processedPhotos.forEach(img => zip.file(img.name, img.blob));
                const zipBlob = await zip.generateAsync({type: 'blob'});
                downloadFile(zipBlob, 'images.zip');
            }
            setTimeout(() => showSuccessMessage(getMessage('message_complete')), 1000);
        });

        document.getElementById('photo-clear').addEventListener('click', () => {
            photoFiles = [];
            croppedPhotos = [];
            processedPhotos = [];
            currentImage = null;
            currentImageIndex = 0;
            document.getElementById('crop-section').classList.remove('active');
            document.getElementById('photo-settings').style.display = 'none';
            document.getElementById('photo-file-list').style.display = 'none';
            document.getElementById('photo-stats').style.display = 'none';
            document.getElementById('photo-buttons').style.display = 'none';
            document.getElementById('photo-download').style.display = 'none';
            photoInput.value = '';
        });

        // ============= VIDEO =============
        const videoInput = document.getElementById('video-input');
        const videoUploadArea = document.getElementById('video-upload-area');

        async function loadFFmpeg() {
            if (ffmpegLoaded) return;
            
            const loading = document.getElementById('video-loading');
            loading.style.display = 'flex';
            loading.querySelector('.loading-text').textContent = getMessage('message_preparing');
            
            try {
                ffmpeg = FFmpeg.createFFmpeg({
                    log: false,
                    corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
                });
                
                await ffmpeg.load();
                ffmpegLoaded = true;
                console.log('Video processor ready');
            } catch (error) {
                console.error('Failed to load FFmpeg:', error);
                alert(getMessage('message_loading_failed'));
            } finally {
                loading.style.display = 'none';
            }
        }

        videoUploadArea.addEventListener('click', () => videoInput.click());
        videoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            videoUploadArea.classList.add('dragover');
        });
        videoUploadArea.addEventListener('dragleave', () => {
            videoUploadArea.classList.remove('dragover');
        });
        videoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            videoUploadArea.classList.remove('dragover');
            handleVideoFiles(e.dataTransfer.files);
        });
        videoInput.addEventListener('change', (e) => {
            handleVideoFiles(e.target.files);
        });

        async function handleVideoFiles(files) {
            videoFiles = Array.from(files).filter(file => {
                if (!file.type.startsWith('video/')) return false;
                if (file.size > 100 * 1024 * 1024) { // 100MB 제한
                    alert(`${file.name}${getMessage('message_file_too_large')}`);
                    return false;
                }
                return true;
            });
            
            if (videoFiles.length === 0) {
                alert(getMessage('message_select_valid_video'));
                return;
            }

            // FFmpeg 로드
            await loadFFmpeg();

            processedVideos = [];
            document.getElementById('video-settings').style.display = 'block';
            document.getElementById('video-file-list').style.display = 'block';
            document.getElementById('video-buttons').style.display = 'flex';
            displayVideoFiles();
        }

        function displayVideoFiles() {
            const fileList = document.getElementById('video-file-list');
            fileList.innerHTML = '';
            
            videoFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-status" id="video-status-${index}">${getMessage('status_waiting')}</div>
                `;
                fileList.appendChild(fileItem);
            });
        }

        document.getElementById('video-process').addEventListener('click', async () => {
            if (!ffmpegLoaded) {
                alert(getMessage('message_ready'));
                return;
            }

            const quality = document.querySelector('input[name="video-quality"]:checked').value;
            const resolution = document.querySelector('input[name="video-resolution"]:checked').value;
            const removeAudio = document.getElementById('remove-audio').checked;

            const loading = document.getElementById('video-loading');
            loading.style.display = 'flex';
            const progressBar = document.getElementById('video-progress');
            progressBar.style.display = 'block';
            
            processedVideos = [];
            let totalOriginalSize = 0;
            let totalCompressedSize = 0;

            for (let i = 0; i < videoFiles.length; i++) {
                const file = videoFiles[i];
                const statusEl = document.getElementById(`video-status-${i}`);
                statusEl.textContent = getMessage('status_processing');
                statusEl.className = 'file-status processing';

                try {
                    const processed = await processVideo(file, quality, resolution, removeAudio);
                    processedVideos.push(processed);
                    totalOriginalSize += file.size;
                    totalCompressedSize += processed.blob.size;
                    statusEl.textContent = getMessage('status_complete');
                    statusEl.className = 'file-status complete';
                } catch (error) {
                    console.error('Error:', error);
                    statusEl.textContent = getMessage('status_error');
                    statusEl.className = 'file-status error';
                }

                progressBar.querySelector('.progress-fill').style.width = ((i + 1) / videoFiles.length) * 100 + '%';
            }

            loading.style.display = 'none';
            displayVideoStats(totalOriginalSize, totalCompressedSize);
            showSuccessMessage(`${videoFiles.length}${getMessage('message_compressed_video')}`);
            document.getElementById('video-download').style.display = 'inline-block';
            progressBar.style.display = 'none';
        });

        async function processVideo(file, quality, resolution, removeAudio) {
            const inputName = 'input.mp4';
            const outputName = 'output.mp4';
            const data = new Uint8Array(await file.arrayBuffer());
            ffmpeg.FS('writeFile', inputName, data);
            
            let cmd = ['-i', inputName];
            if (quality === 'low') cmd.push('-crf', '28');
            else if (quality === 'medium') cmd.push('-crf', '23');
            else cmd.push('-crf', '18');
            
            if (resolution !== 'original') {
                if (resolution === '1080') cmd.push('-vf', 'scale=-2:1080');
                else if (resolution === '720') cmd.push('-vf', 'scale=-2:720');
                else if (resolution === '480') cmd.push('-vf', 'scale=-2:480');
            }
            
            if (removeAudio) cmd.push('-an');
            cmd.push('-c:v', 'libx264', '-preset', 'medium', outputName);
            
            await ffmpeg.run(...cmd);
            const outputData = ffmpeg.FS('readFile', outputName);
            const blob = new Blob([outputData.buffer], { type: 'video/mp4' });
            ffmpeg.FS('unlink', inputName);
            ffmpeg.FS('unlink', outputName);
            
            const baseName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
            return { blob: blob, name: `${baseName}.mp4` };
        }

        function displayVideoStats(originalSize, compressedSize) {
            const stats = document.getElementById('video-stats');
            stats.style.display = 'flex';
            stats.style.justifyContent = 'space-around';
            stats.style.textAlign = 'center';
            document.getElementById('video-total-files').textContent = videoFiles.length;
            document.getElementById('video-original-size').textContent = formatFileSize(originalSize);
            document.getElementById('video-compressed-size').textContent = formatFileSize(compressedSize);
            const savedPercentage = Math.round((1 - compressedSize / originalSize) * 100);
            document.getElementById('video-saved').textContent = savedPercentage + '%';
        }

        document.getElementById('video-download').addEventListener('click', async () => {
            if (processedVideos.length === 0) return;
            showSuccessMessage(getMessage('message_preparing'));
            if (processedVideos.length === 1) {
                downloadFile(processedVideos[0].blob, processedVideos[0].name);
            } else {
                const zip = new JSZip();
                processedVideos.forEach(video => zip.file(video.name, video.blob));
                const zipBlob = await zip.generateAsync({type: 'blob'});
                downloadFile(zipBlob, 'videos.zip');
            }
            setTimeout(() => showSuccessMessage(getMessage('message_complete')), 1000);
        });

        document.getElementById('video-clear').addEventListener('click', () => {
            videoFiles = [];
            processedVideos = [];
            document.getElementById('video-settings').style.display = 'none';
            document.getElementById('video-file-list').style.display = 'none';
            document.getElementById('video-stats').style.display = 'none';
            document.getElementById('video-buttons').style.display = 'none';
            document.getElementById('video-download').style.display = 'none';
            videoInput.value = '';
        });

        // ============= UTILS =============
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('reset-settings').addEventListener('click', () => {
            if (confirm(getMessage('message_reset_confirm'))) {
                localStorage.removeItem('ohotoro-settings');
                showSuccessMessage(getMessage('message_initialized'));
                setTimeout(() => location.reload(), 1500);
            }
        });

        window.addEventListener('load', () => {
            initLanguage();
            settings.apply();
        });
    </script>
</body>
</html>
